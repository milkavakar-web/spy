<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>–®–ø–∏–æ–Ω ‚Äî party game</title>
    <style>
        :root{
            --bg:#0b0f19;
            --card:#121a2a;
            --muted:#93a4c7;
            --text:#eaf0ff;
            --accent:#7aa7ff;
            --danger:#ff6b6b;
            --ok:#5eead4;
            --border:rgba(255,255,255,.08);
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 30% 0%, rgba(122,167,255,.18), transparent),
            radial-gradient(900px 500px at 80% 20%, rgba(94,234,212,.10), transparent),
            var(--bg);
            color:var(--text);
            min-height:100vh;
            display:flex;
            justify-content:center;
            padding: 18px 12px 32px;
        }
        .app{width:min(560px,100%);}
        .header{
            display:flex; align-items:center; justify-content:space-between;
            margin: 6px 0 14px;
            gap: 12px;
        }
        .title{
            font-weight:800; font-size:20px; letter-spacing:.2px;
            display:flex; align-items:center; gap:10px;
        }
        .badge{
            font-size:12px; color:var(--muted);
            border:1px solid var(--border);
            padding:4px 8px; border-radius:999px;
            background: rgba(255,255,255,.03);
        }
        .card{
            background: rgba(18,26,42,.92);
            border:1px solid var(--border);
            border-radius:16px;
            padding:16px;
            box-shadow: 0 12px 30px rgba(0,0,0,.35);
            backdrop-filter: blur(6px);
        }
        .row{display:flex; gap:12px; flex-wrap:wrap;}
        .col{flex:1; min-width: 180px;}
        label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px;}
        input[type="number"], select, input[type="text"]{
            width:100%;
            padding:12px 12px;
            border-radius:12px;
            border:1px solid var(--border);
            background: rgba(255,255,255,.03);
            color:var(--text);
            outline:none;
            font-size:16px;
        }
        input[type="text"]{letter-spacing:.3px;}
        .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
        button{
            cursor:pointer;
            border:none;
            border-radius:12px;
            padding:12px 14px;
            background: rgba(255,255,255,.06);
            color:var(--text);
            font-weight:700;
            font-size:15px;
        }
        button.primary{background: linear-gradient(135deg, rgba(122,167,255,.95), rgba(122,167,255,.65)); color:#071024;}
        button.danger{background: linear-gradient(135deg, rgba(255,107,107,.95), rgba(255,107,107,.65)); color:#220707;}
        button.ok{background: linear-gradient(135deg, rgba(94,234,212,.95), rgba(94,234,212,.65)); color:#041514;}
        button:disabled{opacity:.5; cursor:not-allowed;}
        .hint{color:var(--muted); font-size:13px; line-height:1.35; margin-top:10px;}
        .big{
            text-align:center;
            padding: 22px 14px;
            border-radius:16px;
            border:1px dashed rgba(255,255,255,.16);
            background: rgba(255,255,255,.03);
            margin-top: 12px;
        }
        .big .kicker{color:var(--muted); font-size:12px; margin-bottom:10px; letter-spacing:.25px;}
        .big .main{font-size:28px; font-weight:900; line-height:1.1; word-break:break-word;}
        .big .sub{margin-top:10px; color:var(--muted); font-size:13px;}
        .pill{
            display:inline-flex; gap:8px; align-items:center;
            padding:8px 10px; border-radius:999px;
            border:1px solid var(--border);
            background: rgba(255,255,255,.03);
            color:var(--muted);
            font-size:13px;
        }
        .timer{
            font-variant-numeric: tabular-nums;
            font-weight:900;
            font-size:38px;
            text-align:center;
            margin: 6px 0 4px;
            letter-spacing: .5px;
        }
        .center{ text-align:center; }
        .list{
            display:flex; flex-direction:column; gap:8px; margin-top:10px;
        }
        .choice{
            display:flex; align-items:center; justify-content:space-between;
            padding: 12px 12px;
            border-radius:12px;
            border:1px solid var(--border);
            background: rgba(255,255,255,.03);
        }
        .choice b{font-size:15px;}
        .choice small{color:var(--muted);}
        .split{
            display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
            margin-top: 10px;
        }
        .note{
            margin-top:10px; padding:10px 12px;
            border-radius:12px; border:1px solid var(--border);
            background: rgba(255,255,255,.03);
            color:var(--muted);
            font-size:13px;
            line-height:1.35;
        }
        .hr{
            height:1px; background: rgba(255,255,255,.08);
            margin: 14px 0;
        }
        .footer{
            margin-top:12px; color:var(--muted); font-size:12px; text-align:center;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="title">üïµÔ∏è –®–ø–∏–æ–Ω <span class="badge">–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π ‚Ä¢ –æ—Ñ–ª–∞–π–Ω</span></div>
        <div id="phaseBadge" class="pill">‚Ä¶</div>
    </div>
    <div id="root" class="card"></div>
    <div class="footer">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏–≥—Ä–∞ —É–¥–æ–±–Ω–µ–µ, –µ—Å–ª–∏ –≤–∫–ª—é—á–∏—Ç—å ‚Äú–ù–µ –≥–∞—Å–∏—Ç—å —ç–∫—Ä–∞–Ω‚Äù –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.</div>
</div>

<script>
    (() => {
        // ====== –î–ê–ù–ù–´–ï (–ø–∞–∫–µ—Ç—ã —Å–ª–æ–≤) ======
        const PACKS = {
            "–í—Å–µ": [],
            "–§–∏–ª—å–º—ã/–°–µ—Ä–∏–∞–ª—ã": [
                "–®—Ä–µ–∫", "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä", "–í–ª–∞—Å—Ç–µ–ª–∏–Ω –∫–æ–ª–µ—Ü", "–ú–∞—Ç—Ä–∏—Ü–∞", "–ò–≥—Ä–∞ –ø—Ä–µ—Å—Ç–æ–ª–æ–≤",
                "–î—Ä—É–∑—å—è", "–í–æ –≤—Å–µ —Ç—è–∂–∫–∏–µ", "–¢–∏—Ç–∞–Ω–∏–∫", "–ê–≤–∞—Ç–∞—Ä", "–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä",
                "–ß–µ–ª–æ–≤–µ–∫-–ø–∞—É–∫", "–¢–µ–º–Ω—ã–π —Ä—ã—Ü–∞—Ä—å", "–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä", "–§–æ—Ä—Ä–µ—Å—Ç –ì–∞–º–ø", "–û–¥–∏–Ω –¥–æ–º–∞"
            ],
            "–ï–¥–∞": [
                "–ü–∏—Ü—Ü–∞", "–ë—É—Ä–≥–µ—Ä", "–°—É—à–∏", "–®–∞—É—Ä–º–∞", "–ü–µ–ª—å–º–µ–Ω–∏",
                "–ë–æ—Ä—â", "–ü–∞—Å—Ç–∞", "–®–æ–∫–æ–ª–∞–¥", "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ", "–ë–ª–∏–Ω—ã",
                "–ê—Ä–±—É–∑", "–°—ã—Ä", "–ö–æ—Ñ–µ", "–ß–∞–π", "–°–∞–ª–∞—Ç"
            ],
            "–ú–µ–º—ã/–ò–Ω—Ç–µ—Ä–Ω–µ—Ç": [
                "–ö–æ—Ç", "–î–æ–∂", "–†–∏–∫—Ä–æ–ª–ª", "–ü–µ–ø–µ", "–°–º–∞–π–ª–∏–∫",
                "–•–∞–π–ø", "–ë–ª–æ–≥–µ—Ä", "–°—Ç—Ä–∏–º", "–¢—Ä–µ–Ω–¥", "–õ–∞–π–∫",
                "–ú–µ–º", "–ö—Ä–∏–ø—Ç–∞", "–î–æ–Ω–∞—Ç", "–§–µ–π–∫", "–¢–∏–∫—Ç–æ–∫"
            ],
            "–û–±—â–µ–µ": [
                "–°–∞–º–æ–ª–µ—Ç", "–ü–æ–µ–∑–¥", "–ú–æ—Ä–µ", "–ì–æ—Ä–∞", "–®–∫–æ–ª–∞",
                "–†–∞–±–æ—Ç–∞", "–ü—Ä–∞–∑–¥–Ω–∏–∫", "–î–µ–Ω—å–≥–∏", "–ú—É–∑—ã–∫–∞", "–°–ø–æ—Ä—Ç",
                "–°–æ–±–∞–∫–∞", "–ö–Ω–∏–≥–∞", "–¢–µ–ª–µ—Ñ–æ–Ω", "–ú–∞—à–∏–Ω–∞", "–ü–æ–≥–æ–¥–∞"
            ]
        };
        PACKS["–í—Å–µ"] = Object.keys(PACKS)
            .filter(k => k !== "–í—Å–µ")
            .flatMap(k => PACKS[k]);

        // ====== –£–¢–ò–õ–ò–¢–´ ======
        const $ = (sel) => document.querySelector(sel);

        function shuffle(arr){
            const a = arr.slice();
            for(let i=a.length-1;i>0;i--){
                const j = Math.floor(Math.random()*(i+1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function pickRandom(arr){
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function randInt(min, maxInclusive){
            return Math.floor(Math.random() * (maxInclusive - min + 1)) + min;
        }

        function formatTime(seconds){
            const s = Math.max(0, Math.floor(seconds));
            const mm = String(Math.floor(s/60)).padStart(2,'0');
            const ss = String(s%60).padStart(2,'0');
            return `${mm}:${ss}`;
        }

        function normalizeWord(str){
            return (str || "")
                .toLowerCase()
                .trim()
                .replace(/\s+/g, " ")
                .replace(/[—ë]/g, "–µ")
                .replace(/[^a-z–∞-—è0-9 ]/gi, "");
        }

        function makeSpySet(players, spies){
            const idxs = shuffle([...Array(players).keys()]).slice(0, spies); // 0..players-1
            return new Set(idxs);
        }

        function directionLabel(dir){
            return dir === "cw" ? "–ø–æ —á–∞—Å–æ–≤–æ–π" : "–ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π";
        }

        // ====== –°–û–°–¢–û–Ø–ù–ò–ï ======
        const state = {
            phase: "setup", // setup | reveal | ready | round | voting | spycall | result
            settings: {
                players: 6,
                spies: 1,
                timerMode: "5", // "off" | "3" | "5" | "7" | "10"
                pack: "–í—Å–µ",
                customWord: "" // –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —Å–ª–æ–≤–æ –Ω–∞ —Ä–∞—É–Ω–¥ (–æ—á–∏—â–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
            },
            // runtime
            word: null,
            spySet: new Set(),
            reveal: { currentPlayer: 1, shown: false },
            round: {
                secondsLeft: 300,
                running: false,
                intervalId: null,
                startPlayer: null,   // NEW
                direction: null      // NEW: "cw" | "ccw"
            },
            voting: {
                currentVoter: 1,
                chosen: [],
                finalSuspect: null,
                tieNote: null
            },
            spycall: { input: "", returnPhase: "round" },
            result: { winner: null, spyWon: false, endedBy: null } // endedBy: "voting" | "spycall"
        };

        function setPhase(phase){
            state.phase = phase;
            render();
        }

        function getTimerSeconds(){
            const m = state.settings.timerMode;
            if (m === "off") return 0;
            const mins = parseInt(m, 10);
            return mins * 60;
        }

        function stopTimer(){
            if (state.round.intervalId) clearInterval(state.round.intervalId);
            state.round.intervalId = null;
            state.round.running = false;
        }

        function resetRuntimeKeepSettings(){
            stopTimer();
            state.word = null;
            state.spySet = new Set();
            state.reveal = { currentPlayer: 1, shown: false };
            state.round = {
                secondsLeft: getTimerSeconds(),
                running: false,
                intervalId: null,
                startPlayer: null,
                direction: null
            };
            state.voting = { currentVoter: 1, chosen: [], finalSuspect: null, tieNote: null };
            state.spycall = { input: "", returnPhase: "round" };
            state.result = { winner: null, spyWon: false, endedBy: null };
        }

        // ====== –õ–û–ì–ò–ö–ê –ò–ì–†–´ ======
        function startGame(){
            resetRuntimeKeepSettings();

            // 1) —Å–ª–æ–≤–æ: –ª–∏–±–æ –∫–∞—Å—Ç–æ–º–Ω–æ–µ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ), –ª–∏–±–æ —Ä–∞–Ω–¥–æ–º –∏–∑ –ø–∞–∫–∞
            const custom = (state.settings.customWord || "").trim();
            if (custom){
                state.word = custom;
                state.settings.customWord = ""; // –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ
            } else {
                const packName = state.settings.pack;
                const words = PACKS[packName] || [];
                state.word = pickRandom(words);
            }

            // 2) —à–ø–∏–æ–Ω—ã
            state.spySet = makeSpySet(state.settings.players, state.settings.spies);

            setPhase("reveal");
        }

        function finalizeStartOrder(){
            state.round.startPlayer = randInt(1, state.settings.players);
            state.round.direction = (Math.random() < 0.5) ? "cw" : "ccw";
        }

        function nextRevealStep(){
            if (!state.reveal.shown){
                state.reveal.shown = true;
                render();
                return;
            }

            // hide & next player
            state.reveal.shown = false;
            state.reveal.currentPlayer += 1;

            if (state.reveal.currentPlayer > state.settings.players){
                // NEW: –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–≥—Ä–æ–∫–∞ ‚Äî —Ä–∞–Ω–¥–æ–º–∏–º —Å—Ç–∞—Ä—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                finalizeStartOrder();
                setPhase("ready");
            } else {
                render();
            }
        }

        function startRound(){
            setPhase("round");
            if (state.settings.timerMode !== "off"){
                state.round.running = true;
                tickTimer();
                state.round.intervalId = setInterval(tickTimer, 1000);
            }
        }

        function tickTimer(){
            if (state.settings.timerMode === "off") return;
            state.round.secondsLeft -= 1;
            if (state.round.secondsLeft <= 0){
                state.round.secondsLeft = 0;
                stopTimer();
                setPhase("voting");
                return;
            }
            const t = $("#timerText");
            if (t) t.textContent = formatTime(state.round.secondsLeft);
        }

        function goToVoting(){
            stopTimer();
            setPhase("voting");
        }

        function openSpyCall(fromPhase){
            state.spycall.input = "";
            state.spycall.returnPhase = fromPhase || "round";
            setPhase("spycall");
        }

        function cancelSpyCall(){
            setPhase(state.spycall.returnPhase || "round");
        }

        function submitSpyCall(){
            const guess = normalizeWord(state.spycall.input);
            const word = normalizeWord(state.word);

            if (!guess){
                alert("–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ.");
                return;
            }

            const ok = (guess === word);

            state.result.endedBy = "spycall";
            if (ok){
                state.result.spyWon = true;
                state.result.winner = "–®–ø–∏–æ–Ω(—ã)";
            } else {
                state.result.spyWon = false;
                state.result.winner = "–ò–≥—Ä–æ–∫–∏";
            }
            setPhase("result");
        }

        function voteFor(playerNumber){
            const voter = state.voting.currentVoter;
            state.voting.chosen[voter - 1] = playerNumber;
            state.voting.currentVoter += 1;

            if (state.voting.currentVoter > state.settings.players){
                finalizeVoting();
            } else {
                render();
            }
        }

        function finalizeVoting(){
            const counts = new Map();
            for (const p of state.voting.chosen){
                counts.set(p, (counts.get(p) || 0) + 1);
            }

            let max = -1;
            let top = [];
            for (const [p, c] of counts.entries()){
                if (c > max){
                    max = c; top = [p];
                } else if (c === max){
                    top.push(p);
                }
            }

            if (top.length === 1){
                state.voting.finalSuspect = top[0];
                state.voting.tieNote = null;
            } else {
                state.voting.finalSuspect = pickRandom(top);
                state.voting.tieNote = `–ù–∏—á—å—è –º–µ–∂–¥—É: ${top.map(n=>`–ò–≥—Ä–æ–∫ ${n}`).join(", ")}. –°–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–æ: –ò–≥—Ä–æ–∫ ${state.voting.finalSuspect}.`;
            }

            const suspectIsSpy = state.spySet.has(state.voting.finalSuspect - 1);

            state.result.endedBy = "voting";
            if (suspectIsSpy){
                state.result.spyWon = false;
                state.result.winner = "–ò–≥—Ä–æ–∫–∏";
            } else {
                state.result.spyWon = true;
                state.result.winner = "–®–ø–∏–æ–Ω(—ã)";
            }

            setPhase("result");
        }

        function newGame(){
            resetRuntimeKeepSettings();
            state.settings.customWord = "";
            setPhase("setup");
        }

        function playAgainSameSettings(){
            startGame();
        }

        // ====== UI ======
        function phaseTitle(){
            switch(state.phase){
                case "setup": return "–ù–∞—Å—Ç—Ä–æ–π–∫–∞";
                case "reveal": return "–†–∞–∑–¥–∞—á–∞ —Ä–æ–ª–µ–π";
                case "ready": return "–°—Ç–∞—Ä—Ç –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
                case "round": return "–†–∞—É–Ω–¥";
                case "voting": return "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ";
                case "spycall": return "–ù–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ";
                case "result": return "–†–µ–∑—É–ª—å—Ç–∞—Ç";
                default: return state.phase;
            }
        }

        function render(){
            $("#phaseBadge").textContent = `–≠—Ç–∞–ø: ${phaseTitle()}`;

            const root = $("#root");
            if (!root) return;

            if (state.phase === "setup"){
                root.innerHTML = `
        <div class="row">
          <div class="col">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤</label>
            <input id="players" type="number" min="3" max="20" value="${state.settings.players}" />
          </div>
          <div class="col">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–ø–∏–æ–Ω–æ–≤</label>
            <input id="spies" type="number" min="1" max="10" value="${state.settings.spies}" />
          </div>
        </div>

        <label>–°–≤–æ—ë —Å–ª–æ–≤–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ)</label>
        <input id="customWord" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –®—Ä–µ–∫" value="${state.settings.customWord || ""}" />
        <div class="hint">–ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –ø–∞–∫ —Å–ª–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è. –ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã –ø–æ–ª–µ –æ—á–∏—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

        <div class="row">
          <div class="col">
            <label>–¢–∞–π–º–µ—Ä —Ä–∞—É–Ω–¥–∞</label>
            <select id="timer">
              <option value="off" ${state.settings.timerMode==="off"?"selected":""}>–ë–µ–∑ —Ç–∞–π–º–µ—Ä–∞</option>
              <option value="3" ${state.settings.timerMode==="3"?"selected":""}>3 –º–∏–Ω—É—Ç—ã</option>
              <option value="5" ${state.settings.timerMode==="5"?"selected":""}>5 –º–∏–Ω—É—Ç</option>
              <option value="7" ${state.settings.timerMode==="7"?"selected":""}>7 –º–∏–Ω—É—Ç</option>
              <option value="10" ${state.settings.timerMode==="10"?"selected":""}>10 –º–∏–Ω—É—Ç</option>
            </select>
          </div>

          <div class="col">
            <label>–ü–∞–∫ —Å–ª–æ–≤</label>
            <select id="pack">
              ${Object.keys(PACKS).map(name => `
                <option value="${name}" ${state.settings.pack===name?"selected":""}>${name} (${PACKS[name].length})</option>
              `).join("")}
            </select>
          </div>
        </div>

        <div class="note" id="setupNote"></div>

        <div class="btnbar">
          <button class="primary" id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>

        <div class="hint">
          –ü–æ—Å–ª–µ —Ä–∞–∑–¥–∞—á–∏ —Ä–æ–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±–µ—Ä–µ—Ç, –∫—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –∏ –≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É —Ö–æ–¥–∏—Ç—å.
        </div>
      `;

                const playersEl = $("#players");
                const spiesEl = $("#spies");
                const timerEl = $("#timer");
                const packEl = $("#pack");
                const customEl = $("#customWord");
                const noteEl = $("#setupNote");
                const startBtn = $("#startBtn");

                function validateAndFix(){
                    let players = parseInt(playersEl.value, 10);
                    if (Number.isNaN(players)) players = 6;
                    players = Math.max(3, Math.min(20, players));

                    let spies = parseInt(spiesEl.value, 10);
                    if (Number.isNaN(spies)) spies = 1;
                    spies = Math.max(1, Math.min(10, spies));
                    if (spies >= players) spies = players - 1;

                    playersEl.value = players;
                    spiesEl.value = spies;

                    state.settings.players = players;
                    state.settings.spies = spies;
                    state.settings.timerMode = timerEl.value;
                    state.settings.pack = packEl.value;
                    state.settings.customWord = customEl.value;

                    const warnings = [];
                    if (spies >= Math.ceil(players/2)){
                        warnings.push("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —à–ø–∏–æ–Ω–æ–≤ ‚Äî –∏–≥—Ä–æ–∫–∞–º –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–æ.");
                    }

                    const hasCustom = (state.settings.customWord || "").trim().length > 0;
                    if (hasCustom){
                        warnings.push("‚úÖ –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–≤–æ—ë —Å–ª–æ–≤–æ (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ).");
                    } else {
                        const wordsCount = (PACKS[state.settings.pack] || []).length;
                        warnings.push(wordsCount < 5 ? "‚ö†Ô∏è –í –ø–∞–∫–µ –º–∞–ª–æ —Å–ª–æ–≤. –õ—É—á—à–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–∞–∫." : "‚úÖ –°–ª–æ–≤–æ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –∏–∑ –ø–∞–∫–∞.");
                    }

                    noteEl.textContent = warnings.join(" ");
                    startBtn.disabled = false;
                }

                playersEl.addEventListener("input", validateAndFix);
                spiesEl.addEventListener("input", validateAndFix);
                timerEl.addEventListener("change", validateAndFix);
                packEl.addEventListener("change", validateAndFix);
                customEl.addEventListener("input", validateAndFix);

                validateAndFix();
                startBtn.addEventListener("click", startGame);
                return;
            }

            if (state.phase === "reveal"){
                const p = state.reveal.currentPlayer;
                const isSpy = state.spySet.has(p - 1);
                const shown = state.reveal.shown;

                root.innerHTML = `
        <div class="center">
          <div class="pill">–ò–≥—Ä–æ–∫ ${p} –∏–∑ ${state.settings.players}</div>
        </div>

        <div class="big">
          ${!shown ? `
            <div class="kicker">–ü–µ—Ä–µ–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω –ò–≥—Ä–æ–∫—É ${p}</div>
            <div class="main">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å</div>
            <div class="sub">–£–±–µ–¥–∏—Å—å, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–¥–≥–ª—è–¥—ã–≤–∞–µ—Ç üëÄ</div>
          ` : isSpy ? `
            <div class="kicker">–¢–≤–æ—è —Ä–æ–ª—å</div>
            <div class="main" style="color: var(--danger)">–¢–´ ‚Äî –®–ü–ò–û–ù</div>
            <div class="sub">–°–ª–æ–≤–∞ –Ω–µ—Ç. –°–ª—É—à–∞–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π –Ω–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.</div>
          ` : `
            <div class="kicker">–¢–≤–æ—ë —Å–ª–æ–≤–æ</div>
            <div class="main" style="color: var(--ok)">${state.word}</div>
            <div class="sub">–î–∞–≤–∞–π –∫–æ—Å–≤–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã, —á—Ç–æ–±—ã –≤—ã—á–∏—Å–ª–∏—Ç—å —à–ø–∏–æ–Ω–∞.</div>
          `}
        </div>

        <div class="btnbar">
          <button class="${shown ? "ok" : "primary"}" id="revealBtn">
            ${shown ? "–°–∫—Ä—ã—Ç—å –∏ –ø–µ—Ä–µ–¥–∞—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–ª—å"}
          </button>
          <button id="abortBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

                $("#revealBtn").addEventListener("click", nextRevealStep);
                $("#abortBtn").addEventListener("click", newGame);
                return;
            }

            if (state.phase === "ready"){
                const timerText = state.settings.timerMode === "off" ? "–ë–µ–∑ —Ç–∞–π–º–µ—Ä–∞" : `${state.settings.timerMode} –º–∏–Ω`;
                const sp = state.round.startPlayer ?? 1;
                const dir = state.round.direction ?? "cw";

                root.innerHTML = `
        <div class="center">
          <div class="pill">–°–ª–æ–≤–æ –≤—ã–±—Ä–∞–Ω–æ ‚Ä¢ –†–æ–ª–∏ –≤—ã–¥–∞–Ω—ã</div>
        </div>

        <div class="big">
          <div class="kicker">–ö—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –∏ –∫—É–¥–∞ —Ö–æ–¥–∏–º</div>
          <div class="main">–ò–≥—Ä–æ–∫ ${sp}</div>
          <div class="sub">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>${directionLabel(dir)}</b></div>
        </div>

        <div class="note">
          –ò–≥—Ä–æ–∫ ${sp} –¥–∞—ë—Ç –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É, –¥–∞–ª—å—à–µ —Ö–æ–¥–∏—Ç–µ <b>${directionLabel(dir)}</b>.
        </div>

        <div class="big" style="margin-top:12px;">
          <div class="kicker">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="sub">–¢–∞–π–º–µ—Ä: <b>${timerText}</b></div>
        </div>

        <div class="btnbar">
          <button class="primary" id="startRoundBtn">–°—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞</button>
          <button id="abortBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

                $("#startRoundBtn").addEventListener("click", startRound);
                $("#abortBtn").addEventListener("click", newGame);
                return;
            }

            if (state.phase === "round"){
                const timerOff = state.settings.timerMode === "off";
                const sp = state.round.startPlayer ?? 1;
                const dir = state.round.direction ?? "cw";

                root.innerHTML = `
        <div class="center">
          <div class="pill">–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫—Ä—É–≥—É ‚Ä¢ –ù–µ –ø–∞–ª–∏—Ç–µ—Å—å üòÑ</div>
        </div>

        <div class="note">
          –°—Ç–∞—Ä—Ç: <b>–ò–≥—Ä–æ–∫ ${sp}</b> ‚Ä¢ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <b>${directionLabel(dir)}</b>
        </div>

        ${timerOff ? `
          <div class="big">
            <div class="kicker">–¢–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–µ–Ω</div>
            <div class="main">–ò–≥—Ä–∞–π—Ç–µ –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ</div>
            <div class="sub">–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é.</div>
          </div>
        ` : `
          <div class="timer" id="timerText">${formatTime(state.round.secondsLeft)}</div>
          <div class="center"><span class="pill">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</span></div>
        `}

        <div class="btnbar">
          <button class="danger" id="voteBtn">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
          <button class="primary" id="spyCallBtn">–®–ø–∏–æ–Ω: –Ω–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ</button>
          <button id="abortBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;

                $("#voteBtn").addEventListener("click", goToVoting);
                $("#spyCallBtn").addEventListener("click", () => openSpyCall("round"));
                $("#abortBtn").addEventListener("click", newGame);
                return;
            }

            if (state.phase === "voting"){
                const voter = state.voting.currentVoter;

                root.innerHTML = `
        <div class="center">
          <div class="pill">–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ (–ø–µ—Ä–µ–¥–∞–≤–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω)</div>
        </div>

        <div class="big">
          <div class="kicker">–°–µ–π—á–∞—Å –≥–æ–ª–æ—Å—É–µ—Ç</div>
          <div class="main">–ò–≥—Ä–æ–∫ ${voter}</div>
          <div class="sub">–í—ã–±–µ—Ä–∏, –∫—Ç–æ –ø–æ —Ç–≤–æ–µ–º—É –º–Ω–µ–Ω–∏—é —à–ø–∏–æ–Ω</div>
        </div>

        <div class="btnbar">
          <button class="primary" id="spyCallBtn">–®–ø–∏–æ–Ω: –Ω–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ</button>
          <button id="abortBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>

        <div class="list" id="choices"></div>

        <div class="hint">
          –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ: –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≥–æ–ª–æ—Å–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è.
        </div>
      `;

                $("#spyCallBtn").addEventListener("click", () => openSpyCall("voting"));
                $("#abortBtn").addEventListener("click", newGame);

                const choices = $("#choices");
                const players = state.settings.players;
                for (let p=1; p<=players; p++){
                    const div = document.createElement("div");
                    div.className = "choice";
                    div.innerHTML = `<div><b>–ò–≥—Ä–æ–∫ ${p}</b><br><small>–≤—ã–±—Ä–∞—Ç—å</small></div><div>‚û°Ô∏è</div>`;
                    div.addEventListener("click", () => {
                        if (confirm(`–ò–≥—Ä–æ–∫ ${voter}, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≥–æ–ª–æ—Å –∑–∞ –ò–≥—Ä–æ–∫–∞ ${p}?`)){
                            voteFor(p);
                        }
                    });
                    choices.appendChild(div);
                }

                return;
            }

            if (state.phase === "spycall"){
                root.innerHTML = `
        <div class="center">
          <div class="pill">–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ</div>
        </div>

        <div class="big">
          <div class="kicker">–ï—Å–ª–∏ —à–ø–∏–æ–Ω —Ä–µ—à–∏–ª —Ä–∏—Å–∫–Ω—É—Ç—å</div>
          <div class="main">–ù–∞–∑–æ–≤–∏ —Å–ª–æ–≤–æ</div>
          <div class="sub">–ï—Å–ª–∏ –≤–µ—Ä–Ω–æ ‚Äî —à–ø–∏–æ–Ω(—ã) –≤—ã–∏–≥—Ä—ã–≤–∞—é—Ç. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—ã–∏–≥—Ä—ã–≤–∞—é—Ç –∏–≥—Ä–æ–∫–∏.</div>
        </div>

        <label>–°–ª–æ–≤–æ</label>
        <input id="spyInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –®—Ä–µ–∫" value="${state.spycall.input || ""}" />

        <div class="btnbar">
          <button class="primary" id="submitSpyBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button id="cancelSpyBtn">–ù–∞–∑–∞–¥</button>
        </div>
      `;

                const inp = $("#spyInput");
                inp.focus();
                inp.addEventListener("input", () => state.spycall.input = inp.value);

                $("#submitSpyBtn").addEventListener("click", submitSpyCall);
                $("#cancelSpyBtn").addEventListener("click", cancelSpyCall);
                return;
            }

            if (state.phase === "result"){
                const spies = [...state.spySet].map(i => `–ò–≥—Ä–æ–∫ ${i+1}`);
                const suspect = state.voting.finalSuspect;
                const note = state.voting.tieNote;

                const endedByVoting = state.result.endedBy === "voting";
                const endedBySpyCall = state.result.endedBy === "spycall";

                root.innerHTML = `
        <div class="center">
          <div class="pill">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
        </div>

        <div class="big">
          <div class="kicker">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</div>
          <div class="main" style="color:${state.result.spyWon ? "var(--danger)" : "var(--ok)"}">
            ${state.result.winner}
          </div>
          <div class="sub">–ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ: <b>${state.word}</b></div>
        </div>

        <div class="hr"></div>

        <div class="split">
          <div class="pill">–®–ø–∏–æ–Ω(—ã): <b style="color:var(--text)">${spies.join(", ")}</b></div>
          ${endedByVoting && suspect ? `<div class="pill">–í—ã–±—Ä–∞–Ω: <b style="color:var(--text)">–ò–≥—Ä–æ–∫ ${suspect}</b></div>` : ``}
          ${endedBySpyCall ? `<div class="pill">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: <b style="color:var(--text)">–®–ø–∏–æ–Ω –Ω–∞–∑–≤–∞–ª —Å–ª–æ–≤–æ</b></div>` : ``}
        </div>

        ${endedByVoting && note ? `<div class="note">‚ÑπÔ∏è ${note}</div>` : ""}

        ${endedByVoting ? `
          <div class="note">
            –ì–æ–ª–æ—Å–∞: ${state.voting.chosen.map((c, idx) => `–ò–≥—Ä–æ–∫ ${idx+1} ‚Üí –ò–≥—Ä–æ–∫ ${c}`).join(" ‚Ä¢ ")}
          </div>
        ` : `
          <div class="note">
            –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–ª–æ—Å—å (–∏–ª–∏ –±—ã–ª–æ –ø—Ä–µ—Ä–≤–∞–Ω–æ), –ø–æ—Ç–æ–º—É —á—Ç–æ —à–ø–∏–æ–Ω –ø–æ–ø—ã—Ç–∞–ª—Å—è –Ω–∞–∑–≤–∞—Ç—å —Å–ª–æ–≤–æ.
          </div>
        `}

        <div class="btnbar">
          <button class="primary" id="againBtn">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë (—Ç–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)</button>
          <button id="newBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
      `;

                $("#againBtn").addEventListener("click", playAgainSameSettings);
                $("#newBtn").addEventListener("click", newGame);
                return;
            }
        }

        render();
    })();
</script>
</body>
</html>
